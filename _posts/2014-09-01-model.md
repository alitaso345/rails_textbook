---
layout: post
unique_identifier:
 - 'http:/example.jp/bookid_in_url'
 - 'BookID'
 - 'URL'
title: 'モデル'
creator: '五十嵐邦明'
date: '2014-09-01'
categories:
---

# モデル

この章ではデータの長期保存と、その際に使うモデルについて説明します。

説明に使うアプリは前の章でつくったものを引き続き使います。

## データの永続化

コード中で変数に入れたデータは、変数の有効範囲（スコープと言います）が終わると消えてしまいます。以下のコードで説明しましょう。

{% highlight ruby %}
def print_hello_world
  x = "Hello world!"
  puts x
end
{% endhighlight %}

変数 x の有効範囲（スコープ）は、そのメソッドの中だけです。（このような変数をローカル変数と呼びます。）この場合、メソッドfooの実行が終わると変数 x と、それが指すオブジェクトは消えてしまいます。

別の種類の変数として、前の章でも出てきたインスタンス変数(@はじまりの変数)があります。インスタンス変数は、インスタンスオブジェクトがなくなると一緒に消えます。Railsの場合は、1つのリクエスト内が有効範囲だと考えることができます。(ここではおおまかに、ブラウザでのあるページを1回の表示するのが1回のリクエストだと考えて差し支えありません。ですので、別のページを表示したり、リロードを行ったりすると、また新しい別のリクエストになります。) @book のようにインスタンス変数に入れると、コントローラからビューまで使うことができますが、その後なくなります。

それでも、つくったRailsアプリは別のリクエストでも情報が見れますよね？新規入力画面で自分で入力して登録したデータが、ブラウザから何回アクセスしても表示されます。

つまり、複数のリクエストに渡ってデータが保存されていることが分かります。これはインスタンス変数では実現できません。データがずっと残っているのは「データを保存する」仕事をしている「何かの仕組み」があるからなのです。

その仕組みがこの章の主役 モデル(Model) です。

{% image path: assets/model/overview.png, description: モデル %}

この章はモデルについて説明します。また、この章でCRUDのcreateの部分を題材に説明します。(前の章の続きになります。)

{% image path: assets/model/crud-create.png, description: この章の題材 CRUD create %}

コードはこの部分です。

{% image path: assets/model/create-overview.png, description: BooksController create アクション %}

モデルに関する部分はここです。

{% image path: assets/model/create-model.png, description: モデルを使っている箇所 %}

では、モデルの仕事について見ていきましょう。

## モデルの基本的な使い方 その1 保存

モデルを使うとデータを保存することができます。以下の2つの手順を踏むことで保存できます。

{% highlight ruby %}
book = Book.new(title: "ハチミツとクローバー", memo: "美大を舞台にした青春ラブコメ")
{% endhighlight %}

Book.new でBook モデルオブジェクトを作ります。このとき、タイトルとメモの情報を渡すことができます。

尚、モデル名(モデルのクラス名)は英語の単数形にするルールがあります。ここでは Book がモデル名で、単数形になっています。

{% highlight ruby %}
book.save
{% endhighlight %}

Book モデルオブジェクトのsaveメソッドを呼ぶと保存できます。

## モデルの基本的な使い方 その2 読み込み

さきほど保存したデータを読み込んでみましょう。

{% highlight ruby %}
books = Book.all.to_a
{% endhighlight %}

Book.all で保存されているBook Model の全データを取得できます。以前に説明した一覧画面(indexアクション)でこのメソッドが使われています。

`Book.all.to_a` でArrayにBookオブジェクトが詰まって返ってきます。`to_a` はArrayオブジェクトへ変換するメソッドです。

## モデルの基本的な使い方 その3 検索

{% highlight ruby %}
book = Book.where(title: "ハチミツとクローバー").first
book.title #=> "ハチミツとクローバー"
book.memo #=> "美大を舞台にした青春ラブコメ"
{% endhighlight %}

whereメソッドを使うと検索ができます。タイトルが"ハチミツとクローバー"であるBookオブジェクトが返ります。検索結果が複数になることもあるので、firstメソッドで最初の1つを取得しています。

Bookオブジェクトは titleメソッドでタイトルを、memoメソッドでメモをそれぞれ返します。


